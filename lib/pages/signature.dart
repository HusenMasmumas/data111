import 'dart:math';
import 'package:flutter/material.dart';
import 'dart:typed_data';
import 'dart:ui' as ui;
import 'dart:ui';
import 'package:signature/signature.dart';

const kCanvasSize = 200.0;

class ImageGenerator extends StatefulWidget {
  @override
  _ImageGeneratorState createState() => _ImageGeneratorState();
}

class _ImageGeneratorState extends State<ImageGenerator> {
  final SignatureController _controller = SignatureController(
    penStrokeWidth: 1,
    penColor: Colors.black,
    exportBackgroundColor: Colors.white,
  );
  @override
  void initState() {
    super.initState();
    _controller.addListener(() => print('Value changed'));
  }

  final bytes = Uint8List.fromList([
    137,
    80,
    78,
    71,
    13,
    10,
    26,
    10,
    0,
    0,
    0,
    13,
    73,
    72,
    68,
    82,
    0,
    0,
    1,
    10,
    0,
    0,
    0,
    213,
    8,
    6,
    0,
    0,
    0,
    175,
    212,
    190,
    135,
    0,
    0,
    5,
    94,
    73,
    68,
    65,
    84,
    120,
    1,
    237,
    220,
    235,
    138,
    34,
    59,
    20,
    128,
    209,
    105,
    152,
    247,
    127,
    229,
    57,
    199,
    6,
    65,
    164,
    116,
    91,
    86,
    46,
    123,
    39,
    107,
    253,
    117,
    104,
    122,
    98,
    252,
    114,
    177,
    232,
    191,
    255,
    254,
    247,
    7,
    224,
    141,
    191,
    179,
    127,
    1,
    120,
    244,
    243,
    243,
    243,
    199,
    218,
    149,
    143,
    80,
    0,
    33,
    161,
    32,
    13,
    187,
    137,
    188,
    132,
    2,
    8,
    9,
    5,
    16,
    90,
    58,
    20,
    182,
    178,
    208,
    198,
    210,
    161,
    160,
    14,
    81,
    207,
    77,
    40,
    128,
    144,
    80,
    144,
    134,
    93,
    69,
    94,
    66,
    65,
    26,
    34,
    145,
    151,
    80,
    0,
    33,
    161,
    0,
    66,
    66,
    1,
    132,
    132,
    130,
    233,
    92,
    98,
    230,
    39,
    20,
    64,
    72,
    40,
    128,
    144,
    80,
    0,
    33,
    161,
    0,
    66,
    66,
    1,
    132,
    132,
    2,
    8,
    9,
    5,
    16,
    18,
    10,
    166,
    242,
    12,
    69,
    13,
    66,
    1,
    132,
    132,
    2,
    8,
    9,
    5,
    16,
    18,
    10,
    166,
    113,
    63,
    81,
    135,
    80,
    0,
    33,
    161,
    0,
    66,
    66,
    1,
    132,
    132,
    130,
    41,
    220,
    79,
    212,
    34,
    20,
    64,
    72,
    40,
    128,
    144,
    80,
    0,
    33,
    161,
    96,
    56,
    247,
    19,
    245,
    8,
    5,
    16,
    18,
    10,
    32,
    36,
    20,
    64,
    72,
    40,
    128,
    144,
    80,
    48,
    148,
    139,
    204,
    154,
    132,
    2,
    8,
    9,
    5,
    16,
    18,
    10,
    32,
    36,
    20,
    12,
    227,
    126,
    162,
    46,
    161,
    0,
    66,
    66,
    1,
    132,
    132,
    2,
    8,
    9,
    5,
    67,
    184,
    159,
    168,
    77,
    40,
    128,
    144,
    80,
    0,
    33,
    161,
    0,
    66,
    66,
    65,
    119,
    238,
    39,
    234,
    19,
    10,
    32,
    36,
    20,
    64,
    72,
    40,
    128,
    144,
    80,
    208,
    149,
    251,
    137,
    53,
    8,
    5,
    16,
    18,
    10,
    32,
    36,
    20,
    64,
    72,
    40,
    128,
    208,
    178,
    161,
    184,
    93,
    162,
    49,
    151,
    139,
    204,
    117,
    44,
    27,
    138,
    27,
    147,
    20,
    218,
    88,
    58,
    20,
    64,
    27,
    75,
    134,
    194,
    150,
    23,
    218,
    90,
    50,
    20,
    204,
    39,
    214,
    107,
    17,
    10,
    32,
    36,
    20,
    64,
    72,
    40,
    128,
    208,
    114,
    161,
    112,
    54,
    158,
    207,
    123,
    80,
    219,
    209,
    51,
    72,
    203,
    133,
    2,
    248,
    220,
    81,
    20,
    30,
    35,
    127,
    127,
    93,
    40,
    96,
    35,
    207,
    97,
    184,
    69,
    225,
    221,
    14,
    240,
    254,
    186,
    80,
    192,
    194,
    142,
    194,
    240,
    44,
    58,
    38,
    222,
    94,
    23,
    10,
    154,
    114,
    63,
    49,
    223,
    99,
    28,
    90,
    189,
    23,
    66,
    1,
    197,
    125,
    178,
    107,
    184,
    106,
    169,
    80,
    88,
    205,
    114,
    240,
    62,
    244,
    53,
    34,
    12,
    207,
    150,
    10,
    5,
    57,
    136,
    68,
    91,
    51,
    194,
    240,
    76,
    40,
    104,
    198,
    78,
    226,
    186,
    119,
    95,
    87,
    206,
    28,
    95,
    161,
    128,
    73,
    162,
    103,
    24,
    206,
    188,
    214,
    155,
    80,
    192,
    0,
    103,
    163,
    144,
    205,
    50,
    161,
    176,
    237,
    37,
    147,
    12,
    247,
    10,
    45,
    45,
    19,
    10,
    230,
    218,
    57,
    212,
    213,
    119,
    11,
    159,
    16,
    10,
    56,
    97,
    135,
    40,
    28,
    17,
    10,
    56,
    240,
    234,
    175,
    184,
    239,
    16,
    133,
    35,
    66,
    193,
    101,
    149,
    143,
    29,
    159,
    4,
    161,
    242,
    255,
    175,
    149,
    37,
    66,
    225,
    141,
    36,
    114,
    101,
    135,
    96,
    110,
    45,
    18,
    10,
    184,
    115,
    100,
    232,
    67,
    40,
    40,
    73,
    16,
    198,
    18,
    10,
    46,
    233,
    125,
    236,
    19,
    132,
    28,
    132,
    130,
    20,
    4,
    33,
    55,
    161,
    96,
    40,
    65,
    168,
    169,
    124,
    40,
    124,
    227,
    49,
    207,
    187,
    177,
    23,
    132,
    181,
    148,
    15,
    5,
    115,
    121,
    14,
    97,
    15,
    75,
    132,
    194,
    68,
    236,
    231,
    85,
    8,
    238,
    60,
    135,
    176,
    135,
    37,
    66,
    97,
    34,
    94,
    243,
    46,
    6,
    239,
    198,
    54,
    138,
    8,
    235,
    88,
    34,
    20,
    196,
    190,
    141,
    193,
    187,
    159,
    39,
    208,
    251,
    16,
    138,
    133,
    180,
    142,
    1,
    220,
    149,
    14,
    197,
    142,
    171,
    154,
    24,
    48,
    67,
    233,
    80,
    172,
    42,
    123,
    12,
    118,
    12,
    244,
    238,
    132,
    34,
    129,
    213,
    254,
    108,
    26,
    235,
    233,
    18,
    138,
    145,
    183,
    225,
    171,
    220,
    188,
    139,
    3,
    153,
    117,
    9,
    197,
    168,
    73,
    111,
    11,
    12,
    99,
    56,
    122,
    112,
    138,
    56,
    239,
    73,
    40,
    56,
    77,
    44,
    246,
    83,
    54,
    20,
    38,
    235,
    60,
    198,
    125,
    63,
    101,
    67,
    193,
    120,
    226,
    188,
    47,
    161,
    0,
    66,
    66,
    1,
    132,
    132,
    130,
    143,
    56,
    118,
    236,
    77,
    40,
    128,
    80,
    201,
    80,
    88,
    221,
    96,
    172,
    146,
    161,
    0,
    198,
    18,
    10,
    66,
    118,
    112,
    8,
    5,
    16,
    18,
    10,
    32,
    36,
    20,
    188,
    229,
    216,
    193,
    141,
    80,
    0,
    161,
    114,
    161,
    176,
    194,
    193,
    120,
    229,
    66,
    193,
    56,
    162,
    204,
    157,
    80,
    0,
    33,
    161,
    0,
    66,
    66,
    1,
    132,
    132,
    130,
    67,
    238,
    39,
    120,
    36,
    20,
    64,
    168,
    84,
    40,
    172,
    114,
    48,
    71,
    169,
    80,
    48,
    134,
    32,
    243,
    76,
    40,
    56,
    36,
    22,
    60,
    42,
    23,
    10,
    19,
    120,
    12,
    99,
    204,
    163,
    114,
    161,
    48,
    129,
    251,
    18,
    98,
    142,
    148,
    11,
    5,
    48,
    94,
    153,
    80,
    88,
    233,
    96,
    158,
    50,
    161,
    160,
    63,
    49,
    230,
    21,
    161,
    128,
    39,
    183,
    96,
    222,
    61,
    135,
    115,
    215,
    152,
    10,
    5,
    219,
    122,
    12,
    194,
    163,
    123,
    8,
    110,
    175,
    31,
    253,
    155,
    29,
    99,
    33,
    20,
    44,
    47,
    10,
    194,
    43,
    71,
    175,
    239,
    24,
    137,
    27,
    161,
    224,
    215,
    10,
    31,
    128,
    111,
    131,
    112,
    70,
    245,
    49,
    250,
    86,
    137,
    80,
    172,
    48,
    137,
    105,
    231,
    147,
    32,
    152,
    51,
    109,
    149,
    8,
    5,
    251,
    121,
    21,
    131,
    155,
    79,
    2,
    32,
    18,
    109,
    9,
    5,
    83,
    87,
    223,
    17,
    199,
    5,
    174,
    19,
    10,
    186,
    122,
    183,
    51,
    184,
    17,
    132,
    26,
    132,
    130,
    75,
    206,
    134,
    192,
    221,
    65,
    77,
    66,
    177,
    185,
    232,
    131,
    219,
    122,
    71,
    32,
    18,
    53,
    165,
    15,
    133,
    21,
    168,
    191,
    171,
    23,
    135,
    172,
    47,
    125,
    40,
    120,
    45,
    90,
    237,
    63,
    37,
    6,
    68,
    132,
    162,
    163,
    86,
    31,
    228,
    87,
    206,
    126,
    192,
    143,
    118,
    103,
    189,
    127,
    71,
    214,
    32,
    20,
    39,
    156,
    253,
    80,
    101,
    91,
    169,
    93,
    44,
    242,
    173,
    223,
    80,
    100,
    95,
    85,
    50,
    253,
    126,
    171,
    125,
    176,
    196,
    130,
    79,
    252,
    134,
    34,
    243,
    68,
    49,
    145,
    251,
    50,
    182,
    124,
    34,
    245,
    209,
    67,
    36,
    250,
    49,
    182,
    156,
    145,
    58,
    20,
    64,
    14,
    66,
    1,
    132,
    132,
    98,
    67,
    142,
    29,
    156,
    37,
    20,
    64,
    72,
    40,
    128,
    80,
    218,
    80,
    216,
    30,
    247,
    97,
    92,
    249,
    70,
    218,
    80,
    0,
    121,
    8,
    5,
    16,
    18,
    138,
    141,
    56,
    118,
    240,
    45,
    161,
    0,
    66,
    66,
    1,
    132,
    82,
    134,
    194,
    22,
    185,
    61,
    99,
    202,
    21,
    41,
    67,
    1,
    228,
    34,
    20,
    64,
    72,
    40,
    54,
    224,
    216,
    193,
    85,
    66,
    177,
    9,
    177,
    224,
    10,
    161,
    216,
    132,
    72,
    112,
    69,
    186,
    80,
    88,
    249,
    218,
    50,
    158,
    180,
    144,
    46,
    20,
    64,
    62,
    66,
    1,
    132,
    132,
    2,
    8,
    9,
    197,
    194,
    220,
    79,
    208,
    138,
    80,
    0,
    161,
    84,
    161,
    176,
    2,
    66,
    78,
    169,
    66,
    65,
    59,
    162,
    75,
    75,
    233,
    66,
    97,
    130,
    67,
    62,
    233,
    66,
    33,
    18,
    144,
    79,
    154,
    80,
    216,
    73,
    64,
    94,
    105,
    66,
    65,
    59,
    162,
    75,
    107,
    66,
    177,
    40,
    177,
    160,
    37,
    161,
    88,
    148,
    72,
    208,
    82,
    138,
    80,
    88,
    253,
    32,
    183,
    20,
    161,
    160,
    29,
    209,
    165,
    7,
    161,
    0,
    66,
    66,
    1,
    132,
    166,
    135,
    194,
    86,
    25,
    242,
    155,
    30,
    10,
    218,
    17,
    93,
    122,
    17,
    10,
    32,
    36,
    20,
    139,
    177,
    171,
    160,
    135,
    169,
    161,
    48,
    169,
    219,
    186,
    141,
    229,
    109,
    76,
    161,
    53,
    59,
    10,
    32,
    36,
    20,
    64,
    72,
    40,
    128,
    208,
    180,
    80,
    184,
    159,
    128,
    58,
    236,
    40,
    128,
    144,
    111,
    61,
    128,
    208,
    212,
    80,
    136,
    4,
    212,
    224,
    232,
    1,
    132,
    166,
    132,
    194,
    145,
    163,
    143,
    251,
    195,
    86,
    198,
    151,
    214,
    236,
    40,
    22,
    114,
    127,
    50,
    83,
    36,
    104,
    77,
    40,
    22,
    35,
    18,
    244,
    32,
    20,
    64,
    104,
    120,
    40,
    108,
    141,
    161,
    30,
    59,
    10,
    32,
    36,
    20,
    64,
    72,
    40,
    128,
    208,
    208,
    80,
    184,
    159,
    128,
    154,
    236,
    40,
    128,
    144,
    111,
    61,
    128,
    208,
    240,
    80,
    136,
    4,
    212,
    51,
    44,
    20,
    118,
    18,
    80,
    151,
    203,
    76,
    32,
    228,
    50,
    19,
    8,
    13,
    13,
    133,
    221,
    4,
    212,
    52,
    36,
    20,
    254,
    78,
    2,
    212,
    246,
    31,
    189,
    61,
    47,
    60,
    254,
    2,
    165,
    126,
    0,
    0,
    0,
    0,
    73,
    69,
    78,
    68,
    174,
    66,
    96,
    130
  ]);
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      home: Builder(
        builder: (BuildContext context) => Scaffold(
          body: Container(
            height: MediaQuery.of(context).size.height,
            decoration: BoxDecoration(
              image: DecorationImage(
                  image: NetworkImage(
                      'https://images.unsplash.com/photo-1547665979-bb809517610d?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=675&q=80'),
                  fit: BoxFit.cover),
            ),
            child: ListView(
              children: <Widget>[
                Container(
                  height: 300,
                  child: const Center(
                    child: Text('Big container to test scrolling issues'),
                  ),
                ),
                //SIGNATURE CANVAS
                Signature(
                  controller: _controller,
                  height: 300,
                  backgroundColor: Colors.white,
                ),
                //OK AND CLEAR BUTTONS
                Container(
                  decoration: const BoxDecoration(color: Colors.black),
                  child: Row(
                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                    mainAxisSize: MainAxisSize.max,
                    children: <Widget>[
                      //SHOW EXPORTED IMAGE IN NEW ROUTE
                      IconButton(
                        icon: const Icon(Icons.check),
                        color: Colors.blue,
                        onPressed: () async {
                          if (_controller.isNotEmpty) {
                            final Uint8List data =
                                await _controller.toPngBytes();
                            print(data);
                            if (data != null) {
                              await Navigator.of(context).push(
                                MaterialPageRoute<void>(
                                  builder: (BuildContext context) {
                                    return Scaffold(
                                      appBar: AppBar(),
                                      body: Container(
                                        height:
                                            MediaQuery.of(context).size.height,
                                        decoration: BoxDecoration(
                                          image: DecorationImage(
                                              image: NetworkImage(
                                                  'https://images.unsplash.com/photo-1547665979-bb809517610d?ixlib=rb-1.2.1&ixid=eyJhcHBfaWQiOjEyMDd9&auto=format&fit=crop&w=675&q=80'),
                                              fit: BoxFit.cover),
                                        ),
                                        child: Center(
                                          child: Container(
                                            width: 300,
                                            color: Colors.grey[300],
                                            child: Column(
                                              children: [
                                                SizedBox(
                                                  height: 30,
                                                ),
                                                Image.memory(bytes),
                                                SizedBox(
                                                  height: 30,
                                                ),
                                                Image.memory(data),
                                              ],
                                            ),
                                          ),
                                        ),
                                      ),
                                    );
                                  },
                                ),
                              );
                            }
                          }
                        },
                      ),
                      //CLEAR CANVAS
                      IconButton(
                        icon: const Icon(Icons.clear),
                        color: Colors.blue,
                        onPressed: () {
                          setState(() => _controller.clear());
                        },
                      ),
                    ],
                  ),
                ),
                Container(
                  height: 300,
                  child: const Center(
                    child: Text('Big container to test scrolling issues'),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
